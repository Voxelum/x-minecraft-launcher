<template>
  <v-card
    ref="card"
    v-draggable-card
    outlined
    draggable
    :class="{ incompatible: !compatible }"
    class="draggable-card cursor-pointer"
    style="margin-top: 10px"
    @dragstart="onDragStart"
    @dragend.prevent="onDragEnd"
    @contextmenu="openContextMenu"
    @mouseenter="hovered = true"
    @mouseleave="hovered = false"
  >
    <v-tooltip top>
      <template #activator="{ on }">
        <div class="pr-2">
          <v-layout
            justify-center
            align-center
            fill-height
            v-on="on"
          >
            <v-flex class="p-0">
              <img
                ref="iconImage"
                v-fallback-img="unknownPack"
                class="select-none h-[125px]"
                :src="pack.icon"
                contain
              >
            </v-flex>
            <v-flex
              xs7
              md8
              lg9
              class="flex-col"
            >
              <div class="py-2 flex flex-col gap-2">
                <text-component
                  v-once
                  style="white-space: normal; word-break: break-word"
                  :source="pack.name"
                  editable
                  class="title"
                  @edit="onEditPackName(pack, $event)"
                />
                <text-component
                  style="white-space: normal; word-break: break-word"
                  :source="pack.description"
                />
              </div>
            </v-flex>
          </v-layout>
          <v-divider
            v-show="pack.tags.length > 0"
            class="mt-1"
          />
          <v-card-actions v-show="pack.tags.length > 0">
            <div>
              <v-chip
                v-for="(tag, index) in pack.tags"
                :key="`${tag}-${index}`"
                :color="getColor(tag)"
                label
                outlined
                close
                @click:close="onDeleteTag(tag)"
              >
                <span
                  contenteditable
                  class="max-w-90 sm:max-w-40 overflow-scroll"
                  :class="{ 'text-white': hovered }"
                  @input.stop="onEditTag($event, index)"
                  @blur="notifyTagChange(pack)"
                >{{ tag }}</span>
              </v-chip>
            </div>
          </v-card-actions>
        </div>
      </template>
      <span>
        {{
          compatible
            ? $t("resourcepack.compatible", {
              format: pack.pack_format,
              version: runtime.minecraft,
            })
            : $t("resourcepack.incompatible", {
              accept: pack.acceptingRange,
              actual: runtime.minecraft,
              format: pack.pack_format,
            })
        }}
      </span>
    </v-tooltip>
  </v-card>
</template>

<script lang=ts>
import { computed, defineComponent, ref, Ref } from '@vue/composition-api'
import { BaseServiceKey, InstanceServiceKey, NO_RESOURCE } from '@xmcl/runtime-api'
import unknownPack from '/@/assets/unknown_pack.png'
import { ResourcePackItem, useCompatible, useDragTransferItem, useI18n, useService, useTagColors, useTags } from '/@/hooks'
import { getColor } from '/@/util/color'
import { required } from '/@/util/props'
import { ContextMenuItem, useContextMenu, useCurseforgeRoute } from '/@/windows/main/composables'

export default defineComponent({
  props: {
    pack: required<ResourcePackItem>(Object),
    isSelected: required<boolean>(Boolean),
  },
  setup(props, context) {
    const iconImage: Ref<any> = ref(null)
    const { state } = useService(InstanceServiceKey)
    const runtime = computed(() => state.instance.runtime)
    const { compatible } = useCompatible(computed(() => props.pack.resource ?? NO_RESOURCE), runtime)
    const { open } = useContextMenu()
    const { $t } = useI18n()
    const { searchProjectAndRoute, goProjectAndRoute } = useCurseforgeRoute()
    const { showItemInDirectory } = useService(BaseServiceKey)
    const card: Ref<any> = ref(null)

    const hovered = ref(false)
    const { colors } = useTagColors()
    const { editTag, createTag, removeTag } = useTags(computed({
      get: () => props.pack.tags,
      set: (v) => { context.emit('tags', v) },
    }))

    useDragTransferItem(computed(() => card.value?.$el as HTMLElement), props.pack.id, props.isSelected ? 'right' : 'left')
    const tags = ref([...props.pack.tags])

    function onDragStart(e: DragEvent) {
      e.dataTransfer!.effectAllowed = 'move'
      if (props.pack.id !== 'vanilla') {
        context.emit('dragstart', e)
      }
      e.dataTransfer!.setDragImage(iconImage.value, 0, 0)
    }
    function onDragEnd(e: DragEvent) {
      if (props.pack.id !== 'vanilla') {
        context.emit('dragend', e)
      }
    }
    function onEditTag(event: Event, index: number) {
      if (event.target && event.target instanceof HTMLElement) {
        editTag(event.target.innerText, index)
      }
    }
    function notifyTagChange(item: ResourcePackItem) {
      item.tags = [...item.tags]
    }
    function onEditPackName(item: ResourcePackItem, name: string) {
      item.name = name
    }
    function openContextMenu(e: MouseEvent) {
      if (props.pack.id === 'vanilla') {
        return
      }
      const menuItems: ContextMenuItem[] = [{
        text: $t('resourcepack.showFile', { file: props.pack.path }),
        children: [],
        onClick: () => {
          showItemInDirectory(props.pack.path)
        },
        icon: 'folder',
      }, {
        text: $t('tag.create'),
        children: [],
        onClick() {
          createTag()
        },
        icon: 'add',
      }]
      if (props.pack.resource && props.pack.resource.curseforge) {
        menuItems.push({
          text: $t('resourcepack.showInCurseforge', { name: props.pack.name }),
          children: [],
          onClick: () => {
            goProjectAndRoute(props.pack.resource!.curseforge!.projectId, 'texture-packs')
          },
          icon: '$vuetify.icons.curseforge',
        })
      } else {
        menuItems.push({
          text: $t('resourcepack.searchOnCurseforge', { name: props.pack.name }),
          children: [],
          onClick: () => {
            searchProjectAndRoute(props.pack.name, 'texture-packs')
          },
          icon: 'search',
        })
      }
      open(e.clientX, e.clientY, menuItems)
    }
    return {
      onEditPackName,
      compatible,
      iconImage,
      onDragStart,
      onDragEnd,
      runtime,
      card,
      onEditTag,
      openContextMenu,
      getColor,
      unknownPack,
      tags,
      colors,
      onDeleteTag: removeTag,
      notifyTagChange,
      hovered,
    }
  },
})
</script>

<style scoped=true>
.incompatible.draggable-card:hover {
  background-color: var(--warning-color-decent);
}
.draggable-card:hover {
  background-color: var(--primary-color);
}
.title {
  max-width: 100%;
  white-space: nowrap;
}
</style>
