<template>
  <div class="flex flex-col max-h-full select-none h-full px-8 py-4 pb-0 gap-3">
    <v-progress-linear
      v-show="refreshing"
      class="absolute top-0 z-10 m-0 p-0 left-0"
      height="3"
      :indeterminate="refreshing"
    />
    <v-card
      class="flex py-1 rounded-lg flex-shrink flex-grow-0 items-center pr-2 gap-2 z-5"
      outlined
      elevation="1"
    >
      <filter-combobox
        class="pr-3 max-w-200 max-h-full"
        :label="$t('modpack.filter')"
      />
      <!-- <v-tooltip bottom>
      <template v-slot:activator="{ on }">-->
      <div class="flex-grow" />
      <v-btn
        icon
        @click="showFolder()"
      >
        <v-icon>folder</v-icon>
      </v-btn>

      <!-- </template>
        {{ $t(`curseforge.mc-mods.description`) }}
      </v-tooltip>-->
      <v-tooltip bottom>
        <template #activator="{ on }">
          <v-btn
            icon
            v-on="on"
            @click="goToCurseforge()"
          >
            <v-icon>
              $vuetify.icons.curseforge
            </v-icon>
          </v-btn>
        </template>
        {{ $t(`curseforge.modpacks.description`) }}
      </v-tooltip>
    </v-card>

    <div
      class="flex overflow-auto h-full flex-col container py-0"
    >
      <refreshing-tile
        v-if="refreshing"
        class="h-full"
      />
      <!-- <hint
        v-else-if="modpacks.length === 0"
        icon="save_alt"
        :text="$t('modpack.dropHint')"
        :absolute="true"
        class="h-full z-0"
      /> -->
      <transition-group
        name="transition-list"
        tag="div"
        class="flex flex-wrap overflow-auto h-full w-full gap-4 items-start"
      >
        <modpack-card
          v-for="(item) in modpacks"
          :key="item.id"
          :item="item"
          @tags="item.tags = $event"
          @dragstart="dragging = item"
          @dragend="dragging = undefined"
          @create="show(item.resource.path)"
        />
      </transition-group>
    </div>
    <div class="absolute w-full bottom-0 flex items-center justify-center mb-10">
      <delete-button
        :visible="!!dragging"
        :drop="onDrop"
      />
    </div>
  </div>
</template>

<script lang=ts>
import { computed, defineComponent, nextTick, onMounted, onUnmounted, reactive, ref, Ref, watch } from '@vue/composition-api'
import FilterCombobox, { useFilterCombobox } from '/@/components/FilterCombobox.vue'
import {
  useDrop,
  useService,
  useInstanceBase, useOperation, useResourceOperation, useRouter, useBusy,
} from '/@/hooks'
import { isModCompatible, InstanceServiceKey, ResourceServiceKey, ModpackResource, PersistedModpackResource, PersistedCurseforgeModpackResource, PersistedMcbbsModpackResource, ResourceType, isPersistedResource } from '@xmcl/runtime-api'
import Hint from '/@/components/Hint.vue'
import RefreshingTile from '/@/components/RefreshingTile.vue'
import ModpackCard from './components/ModpackCard.vue'
import { useDialog } from '../../composables'
import { AddInstanceDialogKey } from '../../components/AddInstanceDialog.vue'
import DeleteButton from './components/DeleteButton.vue'
import { isStringArrayEquals } from '/@/util/equal'

export type ModpackResources = PersistedModpackResource | PersistedCurseforgeModpackResource | PersistedMcbbsModpackResource

export interface ModpackItem {
  resource: ModpackResources
  type: 'raw' | 'curseforge' | 'modrinth'
  tags: string[]
  name: string
  version: string
  author: string
  size: number
  icon: string | undefined
  id: string
}

export default defineComponent({
  components: {
    FilterCombobox,
    ModpackCard,
    DeleteButton,
  },
  setup() {
    const { push } = useRouter()
    const dragging = ref(undefined as undefined | ModpackItem)
    const { state, removeResource, updateResource } = useService(ResourceServiceKey)
    const items: Ref<ModpackItem[]> = ref([])
    const { show } = useDialog(AddInstanceDialogKey)
    function getFilterOptions(item: ModpackItem) {
      return [
        { label: 'info', value: item.type, color: 'lime' },
        ...item.tags.map(t => ({ type: 'tag', value: t, label: 'label' })),
      ]
    }
    const refreshing = useBusy('loadDomain(modpacks:resource)')
    const filterOptions = computed(() => items.value.map(getFilterOptions).reduce((a, b) => [...a, ...b], []))
    const { filter } = useFilterCombobox(filterOptions, getFilterOptions, (v) => `${v.name} ${v.author} ${v.version}`)
    function showFolder() {

    }
    function getModpackItem (resource: ModpackResources): ModpackItem {
      return reactive({
        resource,
        id: resource.hash,
        size: resource.size,
        icon: resource.iconUri,
        name: resource.type === ResourceType.CurseforgeModpack || resource.type === ResourceType.McbbsModpack ? resource.metadata.name : '',
        version: resource.type === ResourceType.CurseforgeModpack || resource.type === ResourceType.McbbsModpack ? resource.metadata.version : '',
        author: resource.type === ResourceType.CurseforgeModpack || resource.type === ResourceType.McbbsModpack ? resource.metadata.author : '',
        tags: [...resource.tags],
        type: resource.type === ResourceType.Modpack ? 'raw' : resource.type === ResourceType.CurseforgeModpack ? 'curseforge' : 'modrinth',
      })
    }
    function onDrop() {
      if (dragging.value) {
        removeResource(dragging.value.resource.path)
      }
    }
    const goToCurseforge = () => { push('/curseforge/modpacks') }
    const modpacks = computed(() => filter(items.value))
    onMounted(() => {
      items.value = state.modpacks.map(getModpackItem)
    })
    onUnmounted(() => {
      const editedResources = items.value.filter(i => !isStringArrayEquals(i.tags, i.resource.tags))
      const promises: Promise<any>[] = []
      for (const i of editedResources) {
        promises.push(updateResource({
          resource: i.resource.hash,
          name: i.name,
          tags: i.tags,
        }))
      }
    })
    watch(computed(() => state.modpacks), () => {
      items.value = state.modpacks.map(getModpackItem)
    })
    return {
      onDrop,
      dragging,
      showFolder,
      refreshing,
      modpacks,
      goToCurseforge,
      show,
    }
  },
})
</script>

<style>
</style>
